<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUEC</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¥³</text></svg>">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            background-color: #ffffff;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #000000;
        }
        .main-container {
            padding: 40px 20px;
        }
        .header-accent {
            height: 2px;
            background-color: #e5e7eb;
            margin-bottom: 10px;
        }
        .card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            color: #000000;
            text-align: center;
            padding: 30px 20px 20px;
        }
        .btn-primary {
            background-color: #4b5563;
            border-color: #4b5563;
            border-radius: 6px;
            padding: 12px;
            font-weight: 500;
        }
        .btn-primary:hover {
            background-color: #374151;
            border-color: #374151;
        }
        .btn-primary:focus {
            background-color: #374151;
            border-color: #374151;
            box-shadow: 0 0 0 0.2rem rgba(75,85,99,0.25);
        }
        .btn-primary:disabled {
            background-color: #4b5563;
            border-color: #4b5563;
            opacity: 0.8;
        }
        .form-control, .form-select {
            border-color: #d1d5db;
            border-radius: 6px;
        }
        .form-control:focus, .form-select:focus {
            border-color: #000000;
            box-shadow: 0 0 0 0.2rem rgba(0,0,0,0.1);
        }
        .form-label {
            color: #374151;
            font-weight: 500;
        }
        #results {
            max-height: none;
            overflow: visible;
        }
        .table {
            font-size: 14px;
        }
        .table th {
            background-color: #f9fafb;
            border-top: none;
            font-weight: 600;
            color: #374151;
        }
        .badge {
            font-size: 0.75em;
        }
        .bg-info { background-color: #6b7280 !important; }
        .bg-warning { background-color: #9ca3af !important; }
        .bg-success { background-color: #000000 !important; }
        .bg-danger { background-color: #6b7280 !important; }
        .bg-secondary { background-color: #d1d5db !important; color: #000000 !important; }
        .spinner-border {
            border-color: currentColor;
            border-right-color: transparent;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        .alert {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        .text-primary {
            color: #000000 !important;
        }
        .alert-success .alert-heading {
            color: #000000;
        }
        .card-header.bg-success {
            background-color: #f9fafb !important;
            color: #000000 !important;
            border-bottom: 1px solid #e5e7eb;
        }
        .accordion-collapse {
            overflow: visible !important;
        }
        .accordion-body {
            overflow: visible !important;
        }
        .table-responsive {
            overflow-x: auto;
            overflow-y: visible;
        }
        .metric-label {
            position: relative;
            cursor: help;
            display: inline-block;
        }
        .metric-tooltip {
            position: fixed;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            z-index: 9999;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .metric-tooltip.visible {
            opacity: 1;
        }
        table td {
            overflow: visible !important;
        }
        .sparkline-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 20px;
            max-width: 600px;
        }
        .sparkline-facet {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            border-bottom: 1px solid #e5e7eb;
            background-color: #fafafa;
        }
        .sparkline-title {
            font-size: 0.85em;
            font-weight: 600;
            width: 100px;
            flex-shrink: 0;
            color: #333;
        }
        .sparkline-svg {
            flex-grow: 1;
            height: 40px;
        }
        .sparkline-line {
            fill: none;
            stroke-width: 1.5;
        }
        .sparkline-instructor {
            stroke: #052c65;
        }
        .sparkline-busn {
            stroke: #9ca3af;
        }
        .sparkline-dot {
            fill: white;
            stroke-width: 1.5;
        }
        .sparkline-legend {
            font-size: 0.75em;
            margin-top: 5px;
        }
        .sparkline-legend-item {
            display: inline-block;
            margin-right: 10px;
        }
        .sparkline-legend-line {
            display: inline-block;
            width: 20px;
            height: 2px;
            vertical-align: middle;
            margin-right: 4px;
        }
        .sparkline-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        .sparkline-tab-button {
            padding: 8px 16px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
            margin-bottom: -2px;
        }
        .sparkline-tab-button:hover {
            color: #000000;
        }
        .sparkline-tab-button.active {
            color: #000000;
            border-bottom-color: #000000;
        }
        .sparkline-tab-content {
            display: none;
        }
        .sparkline-tab-content.active {
            display: block;
        }
        /* Histogram styles */
        .histogram-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        .histogram-facet {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-bottom: 1px solid #e5e7eb;
            background-color: #fafafa;
        }
        .histogram-title {
            font-size: 0.85em;
            font-weight: 600;
            width: 100px;
            flex-shrink: 0;
            color: #333;
        }
        .histogram-svg {
            flex-grow: 1;
            height: 60px;
            margin-left: 10px;
        }
        .histogram-bar {
            fill: #052c65;
            transition: fill 0.2s;
        }
        .histogram-bar:hover {
            fill: #083d8a;
        }
        .histogram-axis text {
            font-size: 10px;
            fill: #666;
        }
        .histogram-axis line,
        .histogram-axis path {
            stroke: #ccc;
        }
        .histogram-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        .histogram-tab-button {
            padding: 8px 16px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
            margin-bottom: -2px;
        }
        .histogram-tab-button:hover {
            color: #000000;
        }
        .histogram-tab-button.active {
            color: #000000;
            border-bottom-color: #000000;
        }
        .histogram-tab-content {
            display: none;
        }
        .histogram-tab-content.active {
            display: block;
        }
    </style>

    <script>
    const NOTE_TEXT_DEFAULT = "Note: Summer terms are automatically excluded from all results. Start and end terms are included in results. Analysis based on BUSN classes only. Undergraduate classes (i.e., 4000-level and below) with enrollments below 10 are excluded from statistics.";
    const NOTE_TEXT_FRPA = "Note: Summer terms are automatically excluded from all results. Start and end terms are included in data. Analysis based on BUSN classes only. Undergraduate classes (i.e., 4000-level and below) with enrollments below 10 are excluded from statistics.";
    const NOTE_TEXT_AD_HOC_WITH_SUMMER = "Note: Analysis based on BUSN classes only. Undergraduate classes (i.e., 4000-level and below) with enrollments below 10 are excluded from statistics.";

    const tooltips = {
      Interact: "Interact with other students in a respectful way",
      Reflect: "Reflect on what I was learning",
      Connect: 'Connect my learning to real-world issues/experiences',
      Collab: "Work and learn collaboratively with my classmates",
      Contrib: "Contribute my ideas and thoughts",
      Eval: "Evaluate arguments, evidence, assumptions, and conclusions",
      Synth: "Connect, synthesize, and/or transform ideas into a new form",
      Diverse: "Consider diverse perspectives during class or in assignments",
      Respect: "Demonstrated respect for diverse students/points of view",
      Challenge: "Challenged me to develop knowledge/understanding",
      Creative: "Gave assignments that required original/creative thinking",
      Discuss: "Provided opportunities to ask questions/initiate discussion",
      Feedback: "Provided feedback on my work that helped me improve",
      Grading: "Explained the grading criteria for assignments",
      Questions: "Was available to answer questions or provide assistance",
      Tech: "Effectively used available technology to enhance learning"
    };

    // Helper function to wrap metric names with tooltips
    function wrapMetricWithTooltip(metricName) {
      if (tooltips[metricName]) {
        return `<span class="metric-label" data-tooltip="${tooltips[metricName]}">${metricName}</span>`;
      }
      return metricName;
    }

    // Tooltip management
    let tooltipElement = null;

    function initTooltips() {
      // Create tooltip element if it doesn't exist
      if (!tooltipElement) {
        tooltipElement = document.createElement('div');
        tooltipElement.className = 'metric-tooltip';
        document.body.appendChild(tooltipElement);
      }

      // Add event listeners to all metric labels
      document.addEventListener('mouseover', function(e) {
        if (e.target.classList.contains('metric-label')) {
          const tooltipText = e.target.getAttribute('data-tooltip');
          if (tooltipText) {
            tooltipElement.textContent = tooltipText;

            // Position tooltip to the right of the element
            const rect = e.target.getBoundingClientRect();
            tooltipElement.style.left = (rect.right + 10) + 'px';
            tooltipElement.style.top = (rect.top + rect.height / 2) + 'px';
            tooltipElement.style.transform = 'translateY(-50%)';

            tooltipElement.classList.add('visible');
          }
        }
      });

      document.addEventListener('mouseout', function(e) {
        if (e.target.classList.contains('metric-label')) {
          tooltipElement.classList.remove('visible');
        }
      });
    }
    </script>

</head>
<body>
    <div class="banner" style="background-color: #f8f9fa; border-bottom: 1px solid #e5e7eb; padding: 10px 0;">
        <div class="container">
            <div class="d-flex justify-content-center gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="puecBtn" onclick="setMode('PUEC')">PUEC</button>
                <button class="btn btn-outline-secondary btn-sm" id="frpaBtn" onclick="setMode('FRPA')">FRPA</button>
                <button class="btn btn-outline-secondary btn-sm" id="tenureBtn" onclick="setMode('Tenure')">Tenure</button>
                <button class="btn btn-outline-secondary btn-sm" id="fullBtn" onclick="setMode('Full')">Full</button>
                <button class="btn btn-outline-secondary btn-sm" id="adhocBtn" onclick="setMode('Ad hoc')">Ad hoc</button>
            </div>
        </div>
    </div>
    <div class="header-accent"></div>
    <div class="container main-container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-7">
                <div class="card">
                    <div class="card-header">
                        <h1 class="mb-0">PUEC Party ðŸ¥³</h1>
                        <p class="mb-0 mt-2">Process Faculty Course Questionnaires</p>
                    </div>
                    <div class="card-body p-4">
                        <form id="filterForm">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label for="instructor" class="form-label">Instructor Name</label>
                                    <input type="text" class="form-control" id="instructor" 
                                           placeholder="Start typing instructor name..." 
                                           list="instructorList" autocomplete="off">
<datalist id="instructorList">
  <option value="McMahon, Susan">
  <option value="Stephan, Andrew Perry">
  <option value="Zechman, Sarah LC">
  <option value="Rock, Steven Karl">
  <option value="Rogers, Jonathan Lawrence">
  <option value="Lazzeri, Nicole">
  <option value="Morley, Susan">
  <option value="Probert, Denise Carol">
  <option value="Bondi, Salvatore">
  <option value="Parker, Richard">
  <option value="Maxwell, Christopher">
  <option value="Giehl, Alan Joseph">
  <option value="Milburn, Catherine C">
  <option value="Speck, Sloan G">
  <option value="Tice, Frances Mei-Lin Siu">
  <option value="Cummings, Alex">
  <option value="Straccia, Andrea Rooks">
  <option value="Abeloe, Jaclyn">
  <option value="Rosser, Casey">
  <option value="Gschwindt DE Gyor, Marie Aurelie">
  <option value="Young, Danielle">
  <option value="Duffin, Lance Wade">
  <option value="Middlebrooks, Zavannah Dior">
  <option value="Guenther, Mary">
  <option value="Clark, Heather">
  <option value="Heymann, Stephen">
  <option value="Napier, Vanessa Muriel">
  <option value="Cowan, Sarah Rosenbaum">
  <option value="Zechman, Darrell S">
  <option value="Barday, Debbie Chien-Hui">
  <option value="Elmblad, Christina Kathleen">
  <option value="Baldner, Kelli Elizabeth">
  <option value="Smith, Alfred Warner">
  <option value="Hulse, Heidi">
  <option value="Saha, Susmita">
  <option value="Allen, J Ryan">
  <option value="Arnett, Trina D">
  <option value="Larsen, Kai R">
  <option value="McGee, Micah">
  <option value="Adams, Heather L">
  <option value="Lacek, David">
  <option value="Eargle, David">
  <option value="Gasta, Mark Robert">
  <option value="Ravishankar, Gurumurthi">
  <option value="Stapp, Elizabeth">
  <option value="Lyle, Catherine Carson">
  <option value="Chapple, Nancy Alice">
  <option value="Christoff, Lorna Colleen">
  <option value="Kwaramba, Marcia">
  <option value="Reznicek, Birdie C">
  <option value="Meaney, Mark E">
  <option value="Leach, Chris">
  <option value="Edgar, Stacey">
  <option value="Schaub, Kevin David">
  <option value="Oest, Donald">
  <option value="Carbone, Christopher J">
  <option value="Swisher, Kristin Joy">
  <option value="Cunningham, Cory Brooke">
  <option value="Campbell, Kimberly M">
  <option value="Shukri, Salma">
  <option value="Smith, Julie Scher">
  <option value="Bone, Jennifer Emerling">
  <option value="Auslander, Bonnie">
  <option value="Lionberger, Erin Leigh">
  <option value="Lacy, J Andrew">
  <option value="Young, E Morgan">
  <option value="Lichtenstein, Donald">
  <option value="Hekman, David R">
  <option value="Van Wagoner, Hunter Phoenix">
  <option value="Jennings, Tracy M">
  <option value="Wegner, Jacqueline">
  <option value="Mukhopadhyay, Tathagat">
  <option value="Marshall, Nathan Thomas">
  <option value="Mohr, Peter Justin">
  <option value="Zhang, Xingtan">
  <option value="Fisher, Christina">
  <option value="Zikmund, Noah Todd">
  <option value="Arnold, Mathew">
  <option value="Seward, Lori Elizabeth">
  <option value="Yilmaz, Ovunc">
  <option value="Urrea Castano, Gloria">
  <option value="Maciszewski, Michael Arthur">
  <option value="Nunziato, Joshua">
  <option value="Neil, Joshua Ryan">
  <option value="Li, Ningzi">
  <option value="Bisui, Sandip">
  <option value="McMahon, Kevin Christopher">
  <option value="Papuzza, Antonio">
  <option value="Contreras, Jeremiah">
  <option value="Merrell, Jeffrey Charles">
  <option value="Rahemi, Hasti">
  <option value="Gallo, John">
  <option value="Crofton, Karen Marie">
  <option value="Cass, David">
  <option value="Virden, Thomas W">
  <option value="Carson, Visda">
  <option value="Dobrow, Joseph">
  <option value="Alston, Eric Christopher">
  <option value="Bei, Xiaoshu">
  <option value="Fiske, Leigh Heeter">
  <option value="Bhagat, Sanjai">
  <option value="Albright, Hunter">
  <option value="Werner, Walter">
  <option value="Obreja, Iulian">
  <option value="Brown, Daniel g">
  <option value="Starn Jr, Harry Mohr">
  <option value="Zender, Jaime Francis">
  <option value="Buffa, Andrea">
  <option value="Donchez, Robert M">
  <option value="Hirschhorn, Diane Amy">
  <option value="Waters, Brian Todd">
  <option value="Gardner, David Eugene">
  <option value="Sutton, Holly Meredith">
  <option value="Davies, Shaun William">
  <option value="Stutzer, Michael J.">
  <option value="Robinson, Douglas">
  <option value="Stephenson, Craig Allen">
  <option value="Koc, Ozlem">
  <option value="Donohew, Zachary">
  <option value="Van Wesep, Edward D">
  <option value="Laurion, Henry Richard">
  <option value="Bumbaca, Federico">
  <option value="Goren, Bahriye">
  <option value="Franklin, James H">
  <option value="Gross, David Michael">
  <option value="Smith, Douglas Gene">
  <option value="Campbell, Margaret">
  <option value="Kennedy, Heather Lee">
  <option value="Williams, Lawrence Edwin">
  <option value="Edwards, Emily Jane">
  <option value="Waddell, Jay L">
  <option value="Montealegre, Ramiro">
  <option value="Bennett, Douglas P">
  <option value="Thibodeau, Thomas G">
  <option value="Billings, Stephen Bradley">
  <option value="Mankamyer Jr, Jack Laverne">
  <option value="Denton, D. Keith">
  <option value="Rodgers, Timothy William">
  <option value="D'Esposito Jr, Pasquale George">
  <option value="Hawk, Ashton Lewis">
  <option value="Bailey, Wendy">
  <option value="Laguna, Manuel">
  <option value="Bein, Jonathan Weber">
  <option value="Higgins, Brian">
  <option value="Prinster, David Anthony">
  <option value="Gladstone, Jonathan James">
  <option value="Head, Margaret Teresa">
  <option value="Ramos, Elmer">
  <option value="He, Chuan">
  <option value="Weintraub, William H">
  <option value="Polson, Ksenia">
  <option value="Cookson, John Anthony">
  <option value="Sparling, Keith">
  <option value="Macaluso, Gregg Richard">
  <option value="Nuzum, Paul M">
  <option value="Johnson, Stefanie Kathleen">
  <option value="Barnes, Liza">
  <option value="Rivin, Jessi Mariah">
  <option value="Biegelsen, Katherine M">
  <option value="Ghiselli, Kimberly E">
  <option value="Gallagher, Emily">
  <option value="Covrigaru, Kori">
  <option value="Delprete, Anthony">
  <option value="Woolf, Benjamin Vasey">
  <option value="Schuetz, Kenneth R">
  <option value="Gwozdz, Scott">
  <option value="Nelson, Karen L">
  <option value="Banks, Cynthia Lee">
  <option value="Bercovitz, Janet">
  <option value="Mueller, Erick M">
  <option value="Lawrence, Stephen R">
  <option value="Schonberger, Bryce Alexander">
  <option value="Layman, Ethan">
  <option value="Komor, Patricia Ann">
  <option value="Foley, Shannon E">
  <option value="Denapoli, Sarah">
  <option value="Portilla, Jesus">
  <option value="Ragonetti, Thomas John">
  <option value="Harter, Aaron">
  <option value="Hutchinson, Blake">
  <option value="Lee, Jintae">
  <option value="Williams, Andrew Clement">
  <option value="Radpour, Nelufar Dianna">
  <option value="Taylor, Stephen">
  <option value="Brady, Matthew">
  <option value="Lewis, Mary Beth">
  <option value="Kornish, Laura Joyce">
  <option value="Orton, Kimberly">
  <option value="Meshnick, Jason">
  <option value="Karns, Beverly">
  <option value="Zhang, Huanan">
  <option value="Hill, Scott">
  <option value="Wang, Clare">
  <option value="Chari, Mukund">
  <option value="Khoshsokhan, Sina">
  <option value="Reuer, Jeffrey J">
  <option value="Tong, Wenfeng">
  <option value="Volpone, Sabrina">
  <option value="Anderson, Thomas M">
  <option value="Imel, Spencer Raymond">
  <option value="Vossen, Marie">
  <option value="Embry, Elizabeth">
  <option value="Gillespie-Brown, Jon Simon">
  <option value="Garofolo, Andrew">
  <option value="Hallen, Edward">
  <option value="Whorton, Jody">
  <option value="Jennings, Michael">
  <option value="Bunch, Emma">
  <option value="Douaire, George">
  <option value="Loken, Alexandra C">
  <option value="Szymanski, Michael">
  <option value="Bernstein, Asaf">
  <option value="Ikenberry, David L">
  <option value="Raemdonck, Kimberly">
  <option value="Fleming, Matthew W">
  <option value="Santosh, Shrihari">
  <option value="Kirby, Bradford">
  <option value="Dickinson, Judith Ann">
  <option value="Wobbekind, Richard L">
  <option value="Drake, David">
  <option value="Deriso, George Gergory">
  <option value="York, Jeffrey">
  <option value="Bruder, Daniel">
  <option value="Myers, Michael Edwin">
  <option value="Moyen, Nathalie">
  <option value="Garcia, Diego">
  <option value="Fernbach, Philip M">
  <option value="Frank, Gary Robert">
  <option value="Ferraro, Craig A">
  <option value="Corradino, Arnold Sebastian">
  <option value="Zhang, Rui">
  <option value="Deng, Jing">
  <option value="Laszlo, Karen">
  <option value="Hansen, Scott W">
  <option value="Lynch, John">
  <option value="Reinholtz, Nicholas S">
  <option value="Shriver, Scott">
  <option value="Zhang, Dan">
  <option value="Wang, Zhiyi">
  <option value="Boss, Russel Wayne">
  <option value="Cropanzano, Russell S">
  <option value="Balkin, David">
  <option value="Lacerenza, Christina Noelle">
  <option value="Sears, Curtis R">
  <option value="McQuade, Timothy James">
  <option value="Kercheval, Michael Paul">
  <option value="Smoot, Jennifer">
  <option value="Meister, Matthew">
  <option value="Starbuck, Joel Quintin">
  <option value="Nelson, Thomas Cavett">
  <option value="Egner, Taylor">
  <option value="Emilson, Emanuela">
  <option value="Lien, Alexander">
  <option value="Helmers, John Rockwell">
  <option value="Rolfe, Sikena Katrice">
  <option value="LA Ganga, Linda Rose">
  <option value="Andre, Quentin Patrick Claude">
  <option value="Shin, Dongoh">
  <option value="Kim, Jenny">
  <option value="Cummings, Alexandra Christine">
  <option value="Renegar, Christina Elmblad">
  <option value="Venechuk, Heather Rebecca">
  <option value="Forester, Sally Ann">
  <option value="Stevens, Kelli Elizabeth">
  <option value="Lloyd, Brooke Ann">
  <option value="Wells, Zavannah Dior">
  <option value="Allen, James Ryan">
  <option value="Taylor, Steve">
  <option value="Dark, Ethan">
  <option value="Estrada, Erik Joseph">
  <option value="Hyllested, Corey">
  <option value="Egner, Taylor Adcock">
  <option value="Stafford, Gabrielle Marks">
  <option value="Li, Yuping">
  <option value="Cho, Jae young">
  <option value="Vossen, Thomas Wilhelmus">
  <option value="Brown, David">
  <option value="O'Brien, Tara">
  <option value="Culver, Randal E">
  <option value="Walcott, Nathan Garett">
  <option value="Donchez, Robert Michael">
  <option value="Thompson, Michelle Clara">
  <option value="Bandyopadhyay, Arka Prava">
  <option value="Martin, Wendy">
  <option value="Winter, Margaret">
  <option value="McGraw, Albert Peter">
  <option value="Deon, Kenneth">
  <option value="Gandhi, Fairy Rajesh">
  <option value="Rivin, Jessica Mariah">
  <option value="Lord, Kimberly E">
  <option value="Jahn, Jody L">
  <option value="Roof, Aaron">
  <option value="Petrie, Steven Charles">
  <option value="Moon, Seoyeon Katie">
  <option value="Sang, Lan">
  <option value="Yan, Sen">
  <option value="Szentkiralyi, Levente">
  <option value="Meyers Bass, Elizabeth Kay">
  <option value="Pawliczek, Andrea">
  <option value="Block, Brett">
  <option value="Pisano, Al">
  <option value="Rodriguez Gomez, Hector">
  <option value="Walters, Anne Therese">
  <option value="Fleming, Matthew">
  <option value="Darius, Dries">
  <option value="McNary, Judith Dickinoson">
  <option value="Lau, Catherine Ruth">
  <option value="Lorenzen, Peter">
  <option value="Rolfe, Sirena Katrice">
  <option value="Better, Marco Leonardo">
  <option value="Pless, Shanti Das">
  <option value="Holm, Hanno Edgar">
  <option value="Lyu, Chengyi">
  <option value="Dupre, Heather">
  <option value="Liu, Liu">
  <option value="Beckerman, Michael">
  <option value="Peshut, Jeffrey John">
  <option value="Painter, James">
  <option value="Jacobsen, Merna">
  <option value="Oest, Don">
  <option value="Livengood, Scott">
  <option value="Lien, Sasha">
  <option value="Biegelsen, Casey">
  <option value="Chapello, Lisa">
  <option value="McNiece, Carly">
  <option value="Thompson, Sara">
  <option value="Orozco, Brionna">
  <option value="Cisneros, Jorge E">
  <option value="Moore, Laura">
  <option value="Prochaska, Kevin">
  <option value="Wall, Danielle">
  <option value="Napier, Vanessa">
  <option value="Lloyd, Brooke">
  <option value="Hansen, Amanda">
  <option value="Johnson, Zachary">
  <option value="Allen, Ryan">
  <option value="Rukhotskiy, Alexander Yuriy">
  <option value="Burke, Sandra J">
  <option value="Tang, Shaoqin">
  <option value="Leenders, Hugo">
  <option value="Darnell, Megan">
  <option value="Colina, David">
  <option value="Gwozdz, Ronald Scott">
  <option value="Burnes, Ellen">
  <option value="Lewis, Ryan C">
  <option value="Spaenjers, Christophe">
  <option value="Song, Jaehee">
  <option value="Seelye, Elizabeth">
  <option value="Winter, Meg">
  <option value="Ventura, Santiago">
  <option value="Dobolyi, David">
  <option value="Dempsey, William Robert">
  <option value="Mitchell, Rebecca">
  <option value="Knapp, Kevin Anthony">
  <option value="Stoller, Suzanne">
  <option value="Handler, Abram">
  <option value="Ploumitsakos, John Anthony">
  <option value="Van Portfliet, Meghan">
  <option value="Estrada, Erik">
  <option value="Barasch, Alixandra">
  <option value="Moss, Austin">
  <option value="Harris, Cali LaRue">
  <option value="Moss, James Frank">
  <option value="Berk, Sarabeth Giblin">
  <option value="Drain, Hannah Clair">
  <option value="Boehmer, Briana Noelle">
  <option value="McCall, Matt">
  <option value="Ford, Scott">
  <option value="Reznicek, Birdie">
  <option value="Poskanzer, Ethan Joseph">
  <option value="Culver, Randy">
  <option value="Zhou, Guanqun">
  <option value="Yerger, Daniel Mac Kenzie">
  <option value="Weinberger, Gina Marie">
  <option value="Wright, Christopher">
  <option value="Hall, Shane Nikolaus">
  <option value="Kong, Dejun">
  <option value="Aizenman, Daniel">
  <option value="Glynn, Kevin">
  <option value="McGraw, Peter">
  <option value="Bhattacharjee, Amit">
  <option value="Fraser, Sterling Michael">
  <option value="Gandhi, Fairy">
  <option value="Sample, Timothy Alan">
  <option value="Christensen, Brandon">
  <option value="Jones, Clark Robert">
  <option value="Marrero Trujillo, Veronica">
  <option value="Lacy, Andy">
  <option value="Imamura, Chris Keiji">
  <option value="Brull, Gabe">
  <option value="Rogers, Kate">
  <option value="Schroder, Michelle">
  <option value="Bell, Marcus">
  <option value="Rodriguez, Rolando">
  <option value="Robinson, Scott">
  <option value="Griffin, Laura">
  <option value="Sela, Dor">
  <option value="Blumenthal, Maxwell">
  <option value="Abis, Simona">
  <option value="Shi, Ran">
  <option value="Kong, Dejun "Tony"">
  <option value="Robb, William Coulter">
  <option value="Stodden, Deanne Renee">
  <option value="Engel, Kent Richard">
  <option value="Brimah, Amy Eisenhuth">
  <option value="Skinner, Ashley Nicole">
  <option value="Radtke, Alyssa">
  <option value="Ploumitsakos, John">
  <option value="Guven, Basak Melike">
  <option value="Moroco, Laurie J.">
  <option value="Decker, Mallory">
  <option value="Jarek, Katie R">
  <option value="Bunch, Emma Katherine">
  <option value="Marks, Krista M">
  <option value="Bernstein, David Matthew">
  <option value="Moore, Cody Benjamin">
  <option value="Baum, Kevin">
  <option value="Stierwalt, Evangelia L">
  <option value="Johnson, Luke">
  <option value="Enterkin, Brittany">
  <option value="Burger, Brea Desiree">
  <option value="Overdyke, Scott Tucker">
  <option value="Fox, Mairi-Jane Venesky">
  <option value="Jones, William Shannon">
  <option value="Crofton, Karen">
  <option value="Gilpin, Scott Kirk">
  <option value="Johnson, Jeff">
  <option value="Markman, Gideon Dov">
  <option value="Miao, Sentao">
  <option value="Popken, Douglas">
  <option value="Ahn, Gwen">
  <option value="Starzl, Ravi Suryavanshi">
  <option value="Thatcher, Jason">
  <option value="Mitchell, Becca Lynne">
  <option value="Amozegar, Mahdiyeh">
  <option value="Cowan, Sarah">
  <option value="Elganzoury, Ash">
  <option value="Shen, Boyu">
  <option value="Obeng, Emmanuella Takyiwah">
  <option value="Han, Boyan">
  <option value="Ortez, Kirsten">
  <option value="Mertz, Zoe">
  <option value="Rea, Rachel">
  <option value="Winkler, Emily">
  <option value="Sanchez, Laura Garcia">
  <option value="Hoffman, Ben">
  <option value="Susol, Mark Alexander">
  <option value="Newell, Katrina D">
  <option value="Alexander, Julie Kathryn">
  <option value="Fabian, Carly Leilani">
  <option value="Higgins, Matthew">
  <option value="Zimmermann, Nicole">
  <option value="Ragaglia, Ryan">
  <option value="Hunter, Nicole">
  <option value="Brown, Conner">
  <option value="Marti Cunquero, Rafael">
  <option value="Garrard, Vera">
  <option value="Laverty, David Frank">
  <option value="Duffy, Kyle R">
  <option value="Yu, Xiaobo">
  <option value="Cheston, James">
  <option value="Butt, Jeffrey R">
  <option value="Zeng, Ying">
  <option value="Jeans, Russell">
  <option value="Bryant, Mattie">
  <option value="Zeas, Joanne">
  <option value="Kilpela, Jennifer Mandeville">
  <option value="Benson, Virginia Marie">
  <option value="Zhang, Shuai">
  <option value="Dixon, Leonard">
  <option value="Hanssen, Kristian B">
  <option value="Ramos, Manuel Guillermo">
  <option value="Arisoy, Enfal">
  <option value="Mehder, Serkan">
  <option value="Lee, Anne">
  <option value="Boos, Eric">
  <option value="Kumawat, Shashi Kant">
  <option value="Da Silva Dias, Rodrigo">
  <option value="Jennings, Tracy">
  <option value="Porter, Kirsten">
  <option value="Ansari, Chris">
  <option value="Hobbs, Devren Jean">
  <option value="Guiliano, Philip">
  <option value="Bahl, Marie Y">
  <option value="Davenport, Roseanne">
  <option value="Moskowitz, Georgie">
  <option value="Michalski, Joseph Peter">
  <option value="Liska, Rikke Marie">
  <option value="Shankar, Nithya">
  <option value="Wolkov, Seth Martin">
  <option value="David, Maggie">
  <option value="nasser, karlston">
  <option value="O Neil, PJ">
  <option value="Blythe, Paul">
  <option value="Villa Betancur, Sebastian">
</datalist>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="startYear" class="form-label">Start term</label>
                                    <select class="form-select" id="startYear">
                                        <option value="">Select start term...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="endYear" class="form-label">End term</label>
                                    <select class="form-select" id="endYear" style="display: none;">
                                        <option value="">Select end term...</option>
                                    </select>
                                    <div class="form-control" id="endYearDisplay" style="background-color: #f8f9fa; color: #6c757d;">
                                        Select start term
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3" id="summerTermRow" style="display: none;">
                                <div class="col-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="includeSummer">
                                        <label class="form-check-label" for="includeSummer">
                                            Include summer terms
                                        </label>
                                    </div>
                                </div>
                            </div>

                            

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                    Process FCQs
                                </button>
                            </div>

                            <div class="mt-3 text-center">
                                <small class="text-muted fst-italic" id="modeNote">
                                </small>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="results" class="mt-4" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://hl9a4tetlj.execute-api.us-east-1.amazonaws.com/prod/fcq';

        async function fetchLongitudinalScores(instructor) {
            try {
                console.log('Fetching longitudinal scores for:', instructor);

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'get_longitudinal_scores',
                        instructor: instructor
                    })
                });

                const responseText = await response.text();
                console.log('Longitudinal scores raw response:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse longitudinal scores response:', parseError);
                    return null;
                }

                console.log('Longitudinal scores parsed data:', data);

                // Handle the Lambda response format
                if (data.statusCode && data.body) {
                    const actualData = JSON.parse(data.body);
                    if (data.statusCode === 200 && actualData.success) {
                        console.log('Longitudinal scores data:', actualData.data);
                        return actualData.data;
                    } else {
                        console.error('Longitudinal scores error:', actualData.error);
                        return null;
                    }
                } else if (data.success) {
                    console.log('Longitudinal scores data:', data.data);
                    return data.data;
                } else {
                    console.error('Longitudinal scores error:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching longitudinal scores:', error);
                return null;
            }
        }

        function createSparklineChart(containerId, metricGroups, sortedYears, instructor, viewType = 'course') {
            const container = d3.select(`#${containerId}`);
            container.html(''); // Clear existing content

            // Filter metrics based on viewType
            const instructorMetrics = ['Respect', 'Challenge', 'Creative', 'Discuss', 'Feedback', 'Grading', 'Questions', 'Tech'];
            const courseMetrics = ['Interact', 'Reflect', 'Connect', 'Collab', 'Eval', 'Synth', 'Diverse'];
            const allMetrics = Object.keys(metricGroups).sort();
            const metrics = viewType === 'instructor'
                ? allMetrics.filter(m => instructorMetrics.includes(m)).sort()
                : allMetrics.filter(m => courseMetrics.includes(m)).sort();

            // Create a facet for each metric
            metrics.forEach(metric => {
                const facetDiv = container.append('div')
                    .attr('class', 'sparkline-facet');

                facetDiv.append('div')
                    .attr('class', 'sparkline-title')
                    .html(wrapMetricWithTooltip(metric));

                const svg = facetDiv.append('svg')
                    .attr('class', 'sparkline-svg')
                    .attr('viewBox', '0 0 400 40')
                    .attr('preserveAspectRatio', 'xMidYMid meet');

                const margin = {top: 5, right: 10, bottom: 5, left: 10};
                const width = 400 - margin.left - margin.right;
                const height = 40 - margin.top - margin.bottom;

                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                // Prepare data for this metric
                const instructorData = sortedYears.map(year => {
                    const record = metricGroups[metric].instructor.find(r => r.Year === year);
                    return {year, value: record ? record.Score : null};
                }).filter(d => d.value !== null);

                const busnData = sortedYears.map(year => {
                    const record = metricGroups[metric].allBusn.find(r => r.Year === year);
                    return {year, value: record ? record.Score : null};
                }).filter(d => d.value !== null);

                // Skip if no data
                if (instructorData.length === 0 && busnData.length === 0) return;

                // Create scales
                const xScale = d3.scaleLinear()
                    .domain([d3.min(sortedYears), d3.max(sortedYears)])
                    .range([0, width]);

                // Normalize to overall min/max
                const allValues = [...instructorData.map(d => d.value), ...busnData.map(d => d.value)];
                const minValue = d3.min(allValues);
                const maxValue = d3.max(allValues);
                const yScale = d3.scaleLinear()
                    .domain([minValue, maxValue])
                    .range([height, 0]);

                // Create line generator
                const line = d3.line()
                    .x(d => xScale(d.year))
                    .y(d => yScale(d.value));

                // Create tooltip div
                const tooltip = d3.select('body').selectAll('.sparkline-tooltip').data([0]).join('div')
                    .attr('class', 'sparkline-tooltip')
                    .style('position', 'absolute')
                    .style('background', 'rgba(0, 0, 0, 0.8)')
                    .style('color', 'white')
                    .style('padding', '5px 10px')
                    .style('border-radius', '4px')
                    .style('font-size', '12px')
                    .style('pointer-events', 'none')
                    .style('opacity', 0)
                    .style('z-index', 1000);

                // Draw BUSN line (always show in both views)
                if (busnData.length > 0) {
                    g.append('path')
                        .datum(busnData)
                        .attr('class', 'sparkline-line sparkline-busn')
                        .attr('d', line);

                    // Add dots
                    g.selectAll('.dot-busn')
                        .data(busnData)
                        .enter()
                        .append('circle')
                        .attr('class', 'sparkline-dot')
                        .attr('cx', d => xScale(d.year))
                        .attr('cy', d => yScale(d.value))
                        .attr('r', 1.5)
                        .attr('stroke', '#9ca3af');
                }

                // Draw instructor line (foreground, solid)
                if (instructorData.length > 0) {
                    g.append('path')
                        .datum(instructorData)
                        .attr('class', 'sparkline-line sparkline-instructor')
                        .attr('d', line);

                    // Add dots
                    g.selectAll('.dot-instructor')
                        .data(instructorData)
                        .enter()
                        .append('circle')
                        .attr('class', 'sparkline-dot')
                        .attr('cx', d => xScale(d.year))
                        .attr('cy', d => yScale(d.value))
                        .attr('r', 1.5)
                        .attr('stroke', '#052c65');
                }

                // Create vertical line for hover (initially hidden)
                const hoverLine = g.append('line')
                    .attr('class', 'hover-line')
                    .attr('y1', 0)
                    .attr('y2', height)
                    .attr('stroke', 'black')
                    .attr('stroke-width', 1)
                    .style('opacity', 0);

                // Create invisible overlay for hover detection
                const allYears = [...new Set([...instructorData.map(d => d.year), ...busnData.map(d => d.year)])].sort((a, b) => a - b);

                g.append('rect')
                    .attr('width', width)
                    .attr('height', height)
                    .attr('fill', 'transparent')
                    .style('cursor', 'pointer')
                    .on('mousemove', function(event) {
                        const [mouseX] = d3.pointer(event);
                        const year = Math.round(xScale.invert(mouseX));

                        // Find closest year in data
                        const closestYear = allYears.reduce((prev, curr) =>
                            Math.abs(curr - year) < Math.abs(prev - year) ? curr : prev
                        );

                        const x = xScale(closestYear);

                        // Show hover line
                        hoverLine
                            .attr('x1', x)
                            .attr('x2', x)
                            .style('opacity', 1);

                        // Get values for this year
                        const instructorPoint = instructorData.find(d => d.year === closestYear);
                        const busnPoint = busnData.find(d => d.year === closestYear);

                        // Extract instructor last name (split on comma, take first part)
                        const instructorLastName = instructor.split(',')[0];

                        let tooltipHtml = `<strong>Year: ${closestYear}</strong><br/>`;
                        if (instructorPoint) {
                            tooltipHtml += `${instructorLastName}: ${instructorPoint.value.toFixed(2)}<br/>`;
                        }
                        if (busnPoint) {
                            tooltipHtml += `All BUSN: ${busnPoint.value.toFixed(2)}`;
                        }

                        tooltip.transition().duration(100).style('opacity', 1);
                        tooltip.html(tooltipHtml)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 28) + 'px');
                    })
                    .on('mouseout', function() {
                        hoverLine.style('opacity', 0);
                        tooltip.transition().duration(200).style('opacity', 0);
                    });
            });

            // Add legend at the bottom
            const legendDiv = container.append('div')
                .attr('class', 'sparkline-legend')
                .style('margin-top', '10px')
                .style('padding', '10px')
                .style('text-align', 'left');

            // Extract instructor last name (split on comma, take first part)
            const instructorLastName = instructor.split(',')[0];

            // Always show both legends
            legendDiv.append('span')
                .attr('class', 'sparkline-legend-item')
                .html(`<span class="sparkline-legend-line" style="background-color: #052c65;"></span>${instructorLastName}`);

            legendDiv.append('span')
                .attr('class', 'sparkline-legend-item')
                .html('<span class="sparkline-legend-line" style="background-color: #9ca3af;"></span>All BUSN');
        }

        function calculateScoreDistributions(courseGroups) {
            console.log('Calculating score distributions from courseGroups:', courseGroups);

            // Define metrics to analyze (exclude meta metrics)
            const courseMetrics = ['Interact', 'Reflect', 'Connect', 'Collab', 'Eval', 'Synth', 'Diverse'];
            const instructorMetrics = ['Respect', 'Challenge', 'Creative', 'Discuss', 'Feedback', 'Grading', 'Questions', 'Tech'];
            const allMetrics = [...courseMetrics, ...instructorMetrics];

            // Initialize distribution object
            const distributions = {};
            allMetrics.forEach(metric => {
                distributions[metric] = {
                    1: 0,
                    2: 0,
                    3: 0,
                    4: 0,
                    5: 0
                };
            });

            // Iterate through all courses and collect scores
            Object.values(courseGroups).forEach(courseData => {
                courseData.forEach(row => {
                    if (allMetrics.includes(row.Metric) && typeof row.Value === 'number') {
                        // Round to nearest integer (1-5)
                        const roundedScore = Math.max(1, Math.min(5, Math.round(row.Value)));
                        distributions[row.Metric][roundedScore]++;
                    }
                });
            });

            console.log('Calculated distributions:', distributions);
            return distributions;
        }

        function createHistogramChart(containerId, distributions, courseGroups, viewType = 'course') {
            console.log('Creating histogram chart for:', containerId, viewType);

            const container = d3.select(`#${containerId}`);
            container.selectAll('*').remove();

            // Define metrics by category
            const courseMetrics = ['Interact', 'Reflect', 'Connect', 'Collab', 'Eval', 'Synth', 'Diverse'];
            const instructorMetrics = ['Respect', 'Challenge', 'Creative', 'Discuss', 'Feedback', 'Grading', 'Questions', 'Tech'];

            // Filter distributions based on view type
            let metricsToDisplay;
            if (viewType === 'course') {
                metricsToDisplay = courseMetrics;
            } else {
                metricsToDisplay = instructorMetrics;
            }

            // Create histogram container
            const histogramContainer = container.append('div')
                .attr('class', 'histogram-container');

            metricsToDisplay.forEach(metric => {
                if (!distributions[metric]) return;

                const facet = histogramContainer.append('div')
                    .attr('class', 'histogram-facet');

                facet.append('div')
                    .attr('class', 'histogram-title')
                    .html(wrapMetricWithTooltip(metric));

                const svg = facet.append('svg')
                    .attr('class', 'histogram-svg')
                    .attr('width', 300)
                    .attr('height', 60);

                const margin = { top: 5, right: 10, bottom: 20, left: 25 };
                const width = 300 - margin.left - margin.right;
                const height = 60 - margin.top - margin.bottom;

                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                // Prepare data for histogram
                const data = [1, 2, 3, 4, 5].map(score => ({
                    score: score,
                    count: distributions[metric][score] || 0
                }));

                // Scales
                const x = d3.scaleBand()
                    .domain([1, 2, 3, 4, 5])
                    .range([0, width])
                    .padding(0.2);

                const maxCount = d3.max(data, d => d.count) || 1;
                const y = d3.scaleLinear()
                    .domain([0, maxCount])
                    .range([height, 0]);

                // Add bars
                g.selectAll('.histogram-bar')
                    .data(data)
                    .enter()
                    .append('rect')
                    .attr('class', 'histogram-bar')
                    .attr('x', d => x(d.score))
                    .attr('y', d => y(d.count))
                    .attr('width', x.bandwidth())
                    .attr('height', d => height - y(d.count))
                    .append('title')
                    .text(d => `Score ${d.score}: ${d.count} course${d.count !== 1 ? 's' : ''}`);

                // Add x-axis
                g.append('g')
                    .attr('class', 'histogram-axis')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickSize(3));

                // Add y-axis
                g.append('g')
                    .attr('class', 'histogram-axis')
                    .call(d3.axisLeft(y).ticks(3).tickSize(3));

                // Add y-axis label
                g.append('text')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', -margin.left + 10)
                    .attr('x', -height / 2)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '9px')
                    .style('fill', '#666')
                    .text('Count');
            });
        }

        function displayScoreDistributions(courseGroups) {
            console.log('Displaying score distributions');

            // Calculate distributions
            const distributions = calculateScoreDistributions(courseGroups);

            // Build HTML with tabs
            let html = '<div class="mb-4">';
            html += '<div class="histogram-tabs">';
            html += '<button class="histogram-tab-button active" data-tab="course">This Course</button>';
            html += '<button class="histogram-tab-button" data-tab="instructor">This Instructor</button>';
            html += '</div>';
            html += '<div class="histogram-tab-content active" id="courseHistogramTab"></div>';
            html += '<div class="histogram-tab-content" id="instructorHistogramTab"></div>';
            html += '</div>';

            document.getElementById('scoreDistributionsContent').innerHTML = html;

            // Create the histogram charts after the HTML is inserted
            createHistogramChart('courseHistogramTab', distributions, courseGroups, 'course');
            createHistogramChart('instructorHistogramTab', distributions, courseGroups, 'instructor');

            // Add event listeners for tab switching
            document.querySelectorAll('.histogram-tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');

                    // Update button states
                    document.querySelectorAll('.histogram-tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');

                    // Update content visibility
                    document.querySelectorAll('.histogram-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabName}HistogramTab`).classList.add('active');
                });
            });
        }

        function displayLongitudinalData(data, instructor) {
            console.log('Displaying longitudinal data:', data);

            // Group data by metric
            const metricGroups = {};
            const years = new Set();

            data.forEach(row => {
                if (!metricGroups[row.Metric]) {
                    metricGroups[row.Metric] = {
                        instructor: [],
                        allBusn: []
                    };
                }

                years.add(row.Year);

                if (row.Instructor === 'ALL_BUSN') {
                    metricGroups[row.Metric].allBusn.push(row);
                } else {
                    metricGroups[row.Metric].instructor.push(row);
                }
            });

            const sortedYears = Array.from(years).sort((a, b) => a - b);
            console.log('Years found:', sortedYears);
            const metrics = Object.keys(metricGroups).sort();

            // Build HTML for longitudinal display with tabs
            let html = '<div class="mb-4">';
            html += '<div class="sparkline-tabs">';
            html += '<button class="sparkline-tab-button active" data-tab="instructor">This Instructor</button>';
            html += '<button class="sparkline-tab-button" data-tab="course">This Course</button>';
            html += '</div>';
            html += '<div class="sparkline-tab-content active" id="instructorTab"></div>';
            html += '<div class="sparkline-tab-content" id="courseTab"></div>';
            html += '</div>';

            document.getElementById('longitudinalContent').innerHTML = html;

            // Create the sparkline charts after the HTML is inserted
            createSparklineChart('instructorTab', metricGroups, sortedYears, instructor, 'instructor');
            createSparklineChart('courseTab', metricGroups, sortedYears, instructor, 'course');

            // Add event listeners for tab switching
            document.querySelectorAll('.sparkline-tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');

                    // Update button states
                    document.querySelectorAll('.sparkline-tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');

                    // Update tab content visibility
                    document.querySelectorAll('.sparkline-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabName + 'Tab').classList.add('active');
                });
            });
        }

        document.getElementById('filterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const resultsDiv = document.getElementById('results');
            const submitBtn = document.getElementById('submitBtn');
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Loading...';
            
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="card">
                    <div class="card-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 mb-0">Filtering data...</p>
                    </div>
                </div>
            `;
            
            try {
                // Build request payload
                const payload = {};

                const instructor = document.getElementById('instructor').value.trim();

                // Validate that instructor is selected
                if (!instructor) {
                    throw new Error('Please enter an instructor name');
                }

                payload.instructor = instructor;

                // Fetch longitudinal scores for this instructor
                const longitudinalDataPromise = fetchLongitudinalScores(instructor);

                const startYear = document.getElementById('startYear').value;
                const endYear = document.getElementById('endYear').value;

                // Validate that we have both years
                if (!startYear || !endYear) {
                    throw new Error('Please select both start and end terms');
                }

                const startYearInt = parseInt(startYear);
                const endYearInt = parseInt(endYear);

                // Validate that end year is >= start year
                if (endYearInt < startYearInt) {
                    throw new Error('End term must be equal to or after start term');
                }

                // Generate list of terms from start to end
                const terms = [];
                const includeSummer = currentMode === 'Ad hoc' && document.getElementById('includeSummer').checked;

                // Determine start and end term types based on mode
                let startTerm, endTerm;
                if (currentMode === 'FRPA') {
                    // FRPA: Spring start -> Fall end (same year)
                    startTerm = 'Spring';
                    endTerm = 'Fall';
                } else if (currentMode === 'Tenure' || currentMode === 'Full' || currentMode === 'PUEC') {
                    // Tenure/Full/PUEC: Fall start -> Spring end
                    startTerm = 'Fall';
                    endTerm = 'Spring';
                } else if (currentMode === 'Ad hoc') {
                    // Ad hoc: Fall start -> Spring end
                    startTerm = 'Fall';
                    endTerm = 'Spring';
                }

                // Generate terms from start year to end year
                for (let year = startYearInt; year <= endYearInt; year++) {
                    // Add Fall term if we're in the range
                    if (year === startYearInt && startTerm === 'Fall') {
                        terms.push(`Fall ${year}`);
                    } else if (year > startYearInt && year < endYearInt) {
                        terms.push(`Fall ${year}`);
                    } else if (year === endYearInt && endTerm === 'Fall') {
                        terms.push(`Fall ${year}`);
                    }

                    // Add Spring term if we're in the range
                    if (year === startYearInt && startTerm === 'Spring') {
                        terms.push(`Spring ${year}`);
                    } else if (year > startYearInt && year <= endYearInt) {
                        if (year < endYearInt || (year === endYearInt && endTerm === 'Spring')) {
                            terms.push(`Spring ${year}`);
                        }
                    }

                    // Add Summer term if include_summer is checked and this is Ad hoc mode
                    if (includeSummer && year >= startYearInt && year < endYearInt) {
                        terms.push(`Summer ${year + 1}`);
                    } else if (includeSummer && year === endYearInt && endTerm === 'Fall') {
                        terms.push(`Summer ${year}`);
                    }
                }

                // Set the terms array in the payload
                payload.terms = terms;

                console.log('Term list before sending to lambda:', terms);

                // Make API call
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}`);
                }
                
                console.log('Parsed data:', data);
                
                // Handle the Lambda response format (with statusCode, headers, body)
                if (data.statusCode && data.body) {
                    // Lambda is returning the full response object
                    const actualData = JSON.parse(data.body);
                    console.log('actualData:', actualData);
                    if (data.statusCode === 200 && actualData.success) {
                        console.log('About to call displayResults with:', actualData.data.length, 'items');
                        displayResults(actualData.data, actualData.count);
                    } else {
                        throw new Error(actualData.error || `Lambda error: ${data.statusCode}`);
                    }
                } else if (data.success) {
                    // Direct response format
                    displayResults(data.data, data.count);
                } else {
                    throw new Error(data.error || `Response error: ${JSON.stringify(data)}`);
                }

                // Process longitudinal data
                longitudinalDataPromise.then(longitudinalData => {
                    if (longitudinalData && longitudinalData.length > 0) {
                        displayLongitudinalData(longitudinalData, instructor);
                    } else {
                        document.getElementById('longitudinalContent').innerHTML = `
                            <div class="alert alert-info">
                                <p class="mb-0">No longitudinal data available for this instructor.</p>
                            </div>
                        `;
                    }
                }).catch(error => {
                    console.error('Error processing longitudinal data:', error);
                    document.getElementById('longitudinalContent').innerHTML = `
                        <div class="alert alert-warning">
                            <p class="mb-0">Could not load longitudinal data.</p>
                        </div>
                    `;
                });

            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5 class="alert-heading">Error</h5>
                        <p class="mb-0">${error.message}</p>
                    </div>
                `;
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Get report';
            }
        });
        
        async function fetchCourseDataForAllInstructors(courseTitle, startYear, endYear, excludeInstructor) {
            try {
                const payload = {
                    course_title: courseTitle
                };

                if (excludeInstructor) payload.exclude_instructor = excludeInstructor;

                // Generate terms list (same as in main form submission)
                if (startYear && endYear) {
                    const terms = [];
                    const startYearInt = parseInt(startYear);
                    const endYearInt = parseInt(endYear);
                    const includeSummer = currentMode === 'Ad hoc' && document.getElementById('includeSummer').checked;

                    // Determine start and end term types based on mode
                    let startTerm, endTerm;
                    if (currentMode === 'FRPA') {
                        startTerm = 'Spring';
                        endTerm = 'Fall';
                    } else if (currentMode === 'Tenure' || currentMode === 'Full' || currentMode === 'PUEC') {
                        startTerm = 'Fall';
                        endTerm = 'Spring';
                    } else if (currentMode === 'Ad hoc') {
                        startTerm = 'Fall';
                        endTerm = 'Spring';
                    }

                    // Generate terms from start year to end year
                    for (let year = startYearInt; year <= endYearInt; year++) {
                        // Add Fall term if we're in the range
                        if (year === startYearInt && startTerm === 'Fall') {
                            terms.push(`Fall ${year}`);
                        } else if (year > startYearInt && year < endYearInt) {
                            terms.push(`Fall ${year}`);
                        } else if (year === endYearInt && endTerm === 'Fall') {
                            terms.push(`Fall ${year}`);
                        }

                        // Add Spring term if we're in the range
                        if (year === startYearInt && startTerm === 'Spring') {
                            terms.push(`Spring ${year}`);
                        } else if (year > startYearInt && year <= endYearInt) {
                            if (year < endYearInt || (year === endYearInt && endTerm === 'Spring')) {
                                terms.push(`Spring ${year}`);
                            }
                        }

                        // Add Summer term if include_summer is checked and this is Ad hoc mode
                        if (includeSummer && year >= startYearInt && year < endYearInt) {
                            terms.push(`Summer ${year + 1}`);
                        } else if (includeSummer && year === endYearInt && endTerm === 'Fall') {
                            terms.push(`Summer ${year}`);
                        }
                    }

                    payload.terms = terms;
                }
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}`);
                }
                
                // Handle the Lambda response format
                if (data.statusCode && data.body) {
                    const actualData = JSON.parse(data.body);
                    if (data.statusCode === 200 && actualData.success) {
                        return actualData.data;
                    } else {
                        throw new Error(actualData.error || `Lambda error: ${data.statusCode}`);
                    }
                } else if (data.success) {
                    return data.data;
                } else {
                    throw new Error(data.error || `Response error: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                console.error('Error fetching course data for all instructors:', error);
                return null;
            }
        }
        
        function syncTermsHeights(courseIndex) {
            if (!window.courseTermsHeights[courseIndex]) return;

            const instructorCount = window.courseTermsHeights[courseIndex].instructorCount || 0;
            const allInstructorsCount = window.courseTermsHeights[courseIndex].allInstructorsCount || 0;

            // Get the max count
            const maxCount = Math.max(instructorCount, allInstructorsCount);

            // Calculate height based on max count
            let height = 100; // default
            if (maxCount > 5) {
                height = 125;
            } else if (maxCount === 5) {
                height = 115;
            } else if (maxCount < 3) {
                height = 75;
            }

            // Apply height to both left and right Terms Taught rows
            const leftRow = document.querySelector(`.terms-taught-row-left[data-course-index="${courseIndex}"] td:nth-child(2)`);
            const rightRow = document.querySelector(`.terms-taught-row-right[data-course-index="${courseIndex}"] td:nth-child(2)`);

            if (leftRow) {
                leftRow.style.height = `${height}px`;
            }
            if (rightRow) {
                rightRow.style.height = `${height}px`;
            }
        }

        async function displayResults(data, count) {
            console.log('displayResults called with data:', data, 'count:', count);
            const resultsDiv = document.getElementById('results');

            // Initialize global terms heights tracker
            window.courseTermsHeights = {};

            // Handle null or undefined data
            if (!data || !Array.isArray(data)) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h5 class="alert-heading">No Results Found</h5>
                        <p class="mb-0">No data found matching your search criteria. This may mean the instructor did not teach any courses during the selected time period. Please try different filters.</p>
                    </div>
                `;
                return;
            }

            // Store data globally for download
            currentData = data;
            allInstructorsDataForDownload = [];

            if (data.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-info">
                        <h5 class="alert-heading">No Results</h5>
                        <p class="mb-0">No data found matching your criteria. Try adjusting your filters.</p>
                    </div>
                `;
                return;
            }
            
            // Use actual data length if count is undefined
            const actualCount = count || data.length;
            
            // Group data by course for better display
            const courseGroups = {};
            data.forEach(row => {
                const courseKey = `${row.Sbjct} ${row.Crse} - ${row['Crse Title']}`;
                if (!courseGroups[courseKey]) {
                    courseGroups[courseKey] = [];
                }
                courseGroups[courseKey].push(row);
            });
            
            console.log('Building HTML with courseGroups:', Object.keys(courseGroups).length, 'courses');
            
            // Get form values for additional queries
            const startYear = document.getElementById('startYear').value;
            const endYear = document.getElementById('endYear').value;
            
            let html = `
                <div class="card mb-3" id="longitudinal">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Trends for ${document.getElementById('instructor').value.trim() || 'instructor'}</h5>
                    </div>
                    <div class="card-body">
                        <div id="longitudinalContent">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading longitudinal data...</span>
                                </div>
                                <p class="mt-3 mb-0">Loading longitudinal data...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mb-3" id="scoreDistributions">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Score Distributions for ${document.getElementById('instructor').value.trim() || 'instructor'}</h5>
                    </div>
                    <div class="card-body">
                        <div id="scoreDistributionsContent"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <div>
                            <h5 class="mb-0">By-course analysis for ${document.getElementById('instructor').value.trim() || 'instructor'}</h5>
                            <small class="text-muted" style="font-size: 0.8em;">Searched from ${startYear ? 'Fall ' + startYear : 'earliest'} to ${endYear ? 'Spring ' + endYear : 'latest'}</small>
                        </div>
                        <button class="btn btn-outline-dark btn-sm" onclick="downloadData()">
                            <svg width="16" height="16" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>
                            Download CSV
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="accordion" id="courseAccordion">
            `;
            
            // Set initial HTML structure
            resultsDiv.innerHTML = html;

            // Display score distributions
            displayScoreDistributions(courseGroups);

            // Process each course and fetch additional data asynchronously
            const courseEntries = Object.entries(courseGroups);
            
            // First, render all courses with loading indicators
            courseEntries.forEach(([courseKey, courseData], index) => {
                const accordionId = `collapse${index}`;
                
                // Find terms data for this course
                const termsData = courseData.find(row => row.Metric === 'Terms');
                const termsCount = termsData && Array.isArray(termsData.Value) ? termsData.Value.length : 0;
                const termsBadge = termsCount > 0 ? `<span class="badge bg-info ms-2">${termsCount} ${termsCount === 1 ? 'term' : 'terms'} taught</span>` : '';
                
                // Find total sections data for this course
                const sectionsData = courseData.find(row => row.Metric === 'Total_Sections');
                const sectionsCount = sectionsData ? sectionsData.Value : 0;
                const sectionsBadge = sectionsCount > 0 ? `<span class="badge bg-secondary ms-2">${sectionsCount} ${sectionsCount === 1 ? 'section' : 'sections'} taught</span>` : '';
                
                let accordionItemHtml = `
                    <div class="accordion-item" id="course-${index}">
                        <h2 class="accordion-header" id="heading${index}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${accordionId}" aria-expanded="false" aria-controls="${accordionId}">
                                ${courseKey}${termsBadge}${sectionsBadge}
                            </button>
                        </h2>
                        <div id="${accordionId}" class="accordion-collapse collapse" aria-labelledby="heading${index}" data-bs-parent="#courseAccordion">
                            <div class="accordion-body">
                                <div class="row" style="display: flex; align-items: stretch;">
                                    <div class="col-md-6" style="display: flex; flex-direction: column; min-height: 100%;">
                                        <h6 class="mb-3">Instructor: ${document.getElementById('instructor').value.trim() || 'This Instructor'}</h6>
                                        <div class="table-responsive" style="flex: 1; display: flex; flex-direction: column;">
                                            <table class="table table-sm table-hover mb-0" style="table-layout: fixed; width: 100%; flex: 1;">
                                                <tbody>
                `;
                
                // Build instructor-specific data
                // Define metric categories and order
                const metaMetrics = ['Total_Sections', 'Response_Rate', 'Terms'];
                const courseMetrics = ['Interact', 'Reflect', 'Connect', 'Collab', 'Eval', 'Synth', 'Diverse'];
                const instructorMetrics = ['Respect', 'Challenge', 'Creative', 'Discuss', 'Feedback', 'Grading', 'Questions', 'Tech'];

                // Separate metrics into categories
                const metaRows = [];
                const courseRows = [];
                const instructorRows = [];

                courseData.forEach(row => {
                    if (row.Metric === 'Count') return; // Skip Count metric

                    if (metaMetrics.includes(row.Metric)) {
                        metaRows.push(row);
                    } else if (courseMetrics.includes(row.Metric)) {
                        courseRows.push(row);
                    } else if (instructorMetrics.includes(row.Metric)) {
                        instructorRows.push(row);
                    }
                });

                // Sort each category by the defined order
                metaRows.sort((a, b) => metaMetrics.indexOf(a.Metric) - metaMetrics.indexOf(b.Metric));
                courseRows.sort((a, b) => courseMetrics.indexOf(a.Metric) - courseMetrics.indexOf(b.Metric));
                instructorRows.sort((a, b) => instructorMetrics.indexOf(a.Metric) - instructorMetrics.indexOf(b.Metric));

                // Calculate terms count for this instructor and store it globally
                let instructorTermsCount = 0;
                const termsRow = metaRows.find(row => row.Metric === 'Terms');
                if (termsRow && Array.isArray(termsRow.Value)) {
                    instructorTermsCount = termsRow.Value.length;
                }
                // Store in a global map for later access
                window.courseTermsHeights[index] = { instructorCount: instructorTermsCount };

                // Calculate initial height based on instructor count
                let initialHeight = 100;
                if (instructorTermsCount > 5) {
                    initialHeight = 125;
                } else if (instructorTermsCount === 5) {
                    initialHeight = 115;
                } else if (instructorTermsCount < 3) {
                    initialHeight = 75;
                }

                // Render meta metrics (Total Sections, Response Rate, Terms Taught)
                metaRows.forEach(row => {
                    let value = row.Value;
                    let badgeClass = 'bg-secondary';
                    let displayMetric = row.Metric;
                    let useBadge = true;
                    let rowClass = '';

                    if (row.Metric === 'Response_Rate') {
                        badgeClass = 'bg-warning';
                        displayMetric = 'Response Rate';
                        value = typeof value === 'number' ? (value * 100).toFixed(1) + '%' : value;
                        rowClass = 'response-rate-row-left';
                    } else if (row.Metric === 'Terms') {
                        displayMetric = 'Terms Taught';
                        useBadge = false;
                        if (Array.isArray(value)) {
                            value = value.join(', ');
                        }
                        rowClass = 'terms-taught-row-left';
                    } else if (row.Metric === 'Total_Sections') {
                        displayMetric = 'Total Sections';
                        badgeClass = 'bg-secondary';
                        rowClass = 'total-sections-row-left';
                    }

                    const displayValue = useBadge ? `<span class="badge ${badgeClass}">${value}</span>` : value;

                    // Set height for Terms Taught row
                    const heightStyle = row.Metric === 'Terms' ? `height: ${initialHeight}px;` : '';

                    accordionItemHtml += `
                        <tr class="${rowClass}" data-course-index="${index}">
                            <td style="width: 40%; overflow: hidden; text-overflow: ellipsis; vertical-align: top; border-bottom: none;">${displayMetric}</td>
                            <td style="width: 60%; word-wrap: break-word; white-space: ${row.Metric === 'Terms' ? 'normal' : 'nowrap'}; overflow: hidden; ${row.Metric === 'Terms' ? 'overflow-y: auto; display: block;' : ''} vertical-align: top; border-bottom: none; ${heightStyle}">${displayValue}</td>
                        </tr>
                    `;
                });

                // Add "this course" label
                if (courseRows.length > 0) {
                    accordionItemHtml += `
                        <tr>
                            <td colspan="2" style="padding-top: 12px; padding-bottom: 4px; ${metaRows.length > 0 ? 'border-top: 1px solid #e5e7eb;' : ''} border-bottom: none;">
                                <span style="color: #9ca3af; font-size: 0.85em; font-style: italic;">In this course, I was encouraged to</span>
                            </td>
                        </tr>
                    `;
                }

                // Render course-level metrics
                courseRows.forEach(row => {
                    let value = row.Value;
                    let badgeClass = 'bg-secondary';
                    let displayMetric = wrapMetricWithTooltip(row.Metric);
                    let useBadge = true;

                    if (typeof value === 'number') {
                        badgeClass = value >= 4 ? 'bg-success' : value >= 3 ? 'bg-warning' : 'bg-danger';
                    }

                    const displayValue = useBadge ? `<span class="badge ${badgeClass}">${value}</span>` : value;

                    accordionItemHtml += `
                        <tr>
                            <td style="width: 40%; overflow: hidden; text-overflow: ellipsis; vertical-align: top; border-bottom: none;">${displayMetric}</td>
                            <td style="width: 60%; word-wrap: break-word; white-space: nowrap; overflow: hidden; vertical-align: top; border-bottom: none;">${displayValue}</td>
                        </tr>
                    `;
                });

                // Add separator and "this instructor" label
                if (instructorRows.length > 0) {
                    accordionItemHtml += `
                        <tr>
                            <td colspan="2" style="padding-top: 12px; padding-bottom: 4px; border-top: 1px solid #e5e7eb; border-bottom: none;">
                                <span style="color: #9ca3af; font-size: 0.85em; font-style: italic;">In this course, the instructor</span>
                            </td>
                        </tr>
                    `;
                }

                // Render instructor-level metrics
                instructorRows.forEach(row => {
                    let value = row.Value;
                    let badgeClass = 'bg-secondary';
                    let displayMetric = wrapMetricWithTooltip(row.Metric);
                    let useBadge = true;

                    if (typeof value === 'number') {
                        badgeClass = value >= 4 ? 'bg-success' : value >= 3 ? 'bg-warning' : 'bg-danger';
                    }

                    const displayValue = useBadge ? `<span class="badge ${badgeClass}">${value}</span>` : value;

                    accordionItemHtml += `
                        <tr>
                            <td style="width: 40%; overflow: hidden; text-overflow: ellipsis; vertical-align: top; border-bottom: none;">${displayMetric}</td>
                            <td style="width: 60%; word-wrap: break-word; white-space: nowrap; overflow: hidden; vertical-align: top; border-bottom: none;">${displayValue}</td>
                        </tr>
                    `;
                });
                
                accordionItemHtml += `
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-md-6" style="display: flex; flex-direction: column; min-height: 100%;">
                                        <h6 class="mb-3">Other Instructors During Time Period</h6>
                                        <div id="all-instructors-${index}" class="d-flex justify-content-center" style="flex: 1; display: flex; flex-direction: column;">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span class="ms-2 text-muted">Loading comparison data...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add this accordion item to the accordion
                const accordion = document.getElementById('courseAccordion');
                accordion.innerHTML += accordionItemHtml;
            });
            
            // Then fetch the additional data for each course
            courseEntries.forEach(async ([courseKey, courseData], index) => {
                // Get course title for the additional query
                const courseTitle = courseData[0]['Crse Title'];

                // Get the instructor name to exclude from the comparison
                const instructor = document.getElementById('instructor').value.trim();

                // Fetch data for all instructors for this course, excluding the main instructor
                const allInstructorsData = await fetchCourseDataForAllInstructors(courseTitle, startYear, endYear, instructor);
                
                // Store all instructors data for download
                if (allInstructorsData && allInstructorsData.length > 0) {
                    allInstructorsDataForDownload.push(...allInstructorsData);
                }
                
                // Update the "All Instructors" section for this course
                const allInstructorsContainer = document.getElementById(`all-instructors-${index}`);
                
                if (!allInstructorsContainer) return; // Skip if element not found
                
                // Build all instructors data
                if (allInstructorsData && allInstructorsData.length > 0) {
                    // Group by course (should only be one course)
                    const allInstructorsCourseGroups = {};
                    allInstructorsData.forEach(row => {
                        const courseKey = `${row.Sbjct} ${row.Crse} - ${row['Crse Title']}`;
                        if (!allInstructorsCourseGroups[courseKey]) {
                            allInstructorsCourseGroups[courseKey] = [];
                        }
                        allInstructorsCourseGroups[courseKey].push(row);
                    });

                    const firstCourseData = Object.values(allInstructorsCourseGroups)[0];
                    
                    let allInstructorsHtml = `
                        <div class="table-responsive" style="flex: 1; display: flex; flex-direction: column;">
                            <table class="table table-sm table-hover mb-0" style="table-layout: fixed; width: 100%; flex: 1;">
                                <tbody>
                    `;

                    // Define metric categories and order
                    const metaMetrics = ['Total_Sections', 'Response_Rate', 'Terms'];
                    const courseMetrics = ['Interact', 'Reflect', 'Connect', 'Collab', 'Eval', 'Synth', 'Diverse'];
                    const instructorMetrics = ['Respect', 'Challenge', 'Creative', 'Discuss', 'Feedback', 'Grading', 'Questions', 'Tech'];

                    // Separate metrics into categories
                    const metaRows = [];
                    const courseRows = [];
                    const instructorRows = [];

                    firstCourseData.forEach(row => {
                        if (row.Metric === 'Count') return; // Skip Count metric

                        if (metaMetrics.includes(row.Metric)) {
                            metaRows.push(row);
                        } else if (courseMetrics.includes(row.Metric)) {
                            courseRows.push(row);
                        } else if (instructorMetrics.includes(row.Metric)) {
                            instructorRows.push(row);
                        }
                    });

                    // Sort each category by the defined order
                    metaRows.sort((a, b) => metaMetrics.indexOf(a.Metric) - metaMetrics.indexOf(b.Metric));
                    courseRows.sort((a, b) => courseMetrics.indexOf(a.Metric) - courseMetrics.indexOf(b.Metric));
                    instructorRows.sort((a, b) => instructorMetrics.indexOf(a.Metric) - instructorMetrics.indexOf(b.Metric));

                    // Calculate terms count for all instructors
                    let allInstructorsTermsCount = 0;
                    const allTermsRow = metaRows.find(row => row.Metric === 'Terms');
                    if (allTermsRow && Array.isArray(allTermsRow.Value)) {
                        allInstructorsTermsCount = allTermsRow.Value.length;
                    }

                    // Store all instructors count
                    window.courseTermsHeights[index].allInstructorsCount = allInstructorsTermsCount;

                    // Render meta metrics (Total Sections, Response Rate, Terms Taught)
                    metaRows.forEach(row => {
                        let value = row.Value;
                        let badgeClass = 'bg-secondary';
                        let displayMetric = row.Metric;
                        let useBadge = true;
                        let rowClass = '';

                        if (row.Metric === 'Response_Rate') {
                            badgeClass = 'bg-warning';
                            displayMetric = 'Response Rate';
                            value = typeof value === 'number' ? (value * 100).toFixed(1) + '%' : value;
                            rowClass = 'response-rate-row-right';
                        } else if (row.Metric === 'Terms') {
                            displayMetric = 'Terms Taught';
                            useBadge = false;
                            if (Array.isArray(value)) {
                                value = value.join(', ');
                            }
                            rowClass = 'terms-taught-row-right';
                        } else if (row.Metric === 'Total_Sections') {
                            displayMetric = 'Total Sections';
                            badgeClass = 'bg-secondary';
                            rowClass = 'total-sections-row-right';
                        }

                        const displayValue = useBadge ? `<span class="badge ${badgeClass}">${value}</span>` : value;

                        allInstructorsHtml += `
                            <tr class="${rowClass}" data-course-index="${index}">
                                <td style="width: 40%; overflow: hidden; text-overflow: ellipsis; vertical-align: top; border-bottom: none;">${displayMetric}</td>
                                <td style="width: 60%; word-wrap: break-word; white-space: ${row.Metric === 'Terms' ? 'normal' : 'nowrap'}; overflow: hidden; ${row.Metric === 'Terms' ? 'overflow-y: auto; display: block;' : ''} vertical-align: top; border-bottom: none;">${displayValue}</td>
                            </tr>
                        `;
                    });

                    // After inserting HTML, sync the heights on both sides
                    setTimeout(() => {
                        syncTermsHeights(index);
                    }, 100);

                    // Add "this course" label
                    if (courseRows.length > 0) {
                        allInstructorsHtml += `
                            <tr>
                                <td colspan="2" style="padding-top: 12px; padding-bottom: 4px; ${metaRows.length > 0 ? 'border-top: 1px solid #e5e7eb;' : ''} border-bottom: none;">
                                    <span style="color: #9ca3af; font-size: 0.85em; font-style: italic;">In this course, I was encouraged to</span>
                                </td>
                            </tr>
                        `;
                    }

                    // Render course-level metrics
                    courseRows.forEach(row => {
                        let value = row.Value;
                        let badgeClass = 'bg-secondary';
                        let displayMetric = wrapMetricWithTooltip(row.Metric);
                        let useBadge = true;

                        if (typeof value === 'number') {
                            badgeClass = value >= 4 ? 'bg-success' : value >= 3 ? 'bg-warning' : 'bg-danger';
                        }

                        const displayValue = useBadge ? `<span class="badge ${badgeClass}">${value}</span>` : value;

                        allInstructorsHtml += `
                            <tr>
                                <td style="width: 40%; overflow: hidden; text-overflow: ellipsis; vertical-align: top; border-bottom: none;">${displayMetric}</td>
                                <td style="width: 60%; word-wrap: break-word; white-space: nowrap; overflow: hidden; vertical-align: top; border-bottom: none;">${displayValue}</td>
                            </tr>
                        `;
                    });

                    // Add separator and "this instructor" label
                    if (instructorRows.length > 0) {
                        allInstructorsHtml += `
                            <tr>
                                <td colspan="2" style="padding-top: 12px; padding-bottom: 4px; border-top: 1px solid #e5e7eb; border-bottom: none;">
                                    <span style="color: #9ca3af; font-size: 0.85em; font-style: italic;">In this course, the instructor</span>
                                </td>
                            </tr>
                        `;
                    }

                    // Render instructor-level metrics
                    instructorRows.forEach(row => {
                        let value = row.Value;
                        let badgeClass = 'bg-secondary';
                        let displayMetric = wrapMetricWithTooltip(row.Metric);
                        let useBadge = true;

                        if (typeof value === 'number') {
                            badgeClass = value >= 4 ? 'bg-success' : value >= 3 ? 'bg-warning' : 'bg-danger';
                        }

                        const displayValue = useBadge ? `<span class="badge ${badgeClass}">${value}</span>` : value;

                        allInstructorsHtml += `
                            <tr>
                                <td style="width: 40%; overflow: hidden; text-overflow: ellipsis; vertical-align: top; border-bottom: none;">${displayMetric}</td>
                                <td style="width: 60%; word-wrap: break-word; white-space: nowrap; overflow: hidden; vertical-align: top; border-bottom: none;">${displayValue}</td>
                            </tr>
                        `;
                    });
                    
                    allInstructorsHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    allInstructorsContainer.innerHTML = allInstructorsHtml;
                } else {
                    // No other instructors data (either 0 rows returned or no data)
                    allInstructorsContainer.innerHTML = `
                        <div class="alert alert-secondary">
                            <small>There are no other instructors for this course</small>
                        </div>
                    `;
                }
            });
            
            // Close the main HTML structure
            setTimeout(() => {
                const accordion = document.getElementById('courseAccordion');
                const parentDiv = accordion.parentElement;
                parentDiv.innerHTML += `
                        </div>
                    </div>
                `;
            }, 100);
        }
        
        // Global variable to store current data for download
        let currentData = null;
        let allInstructorsDataForDownload = [];
        
        function downloadData() {
            if ((!currentData || currentData.length === 0) && (!allInstructorsDataForDownload || allInstructorsDataForDownload.length === 0)) {
                alert('No data to download');
                return;
            }
            
            console.log('Download data - This Instructor:', currentData?.length || 0, 'rows');
            console.log('Download data - All Instructors:', allInstructorsDataForDownload?.length || 0, 'rows');
            
            // Create a comparison table structure
            const comparisonData = new Map();
            
            // Process current instructor data
            if (currentData && currentData.length > 0) {
                currentData.forEach(row => {
                    // Skip Count metric (same as UI filtering)
                    if (row.Metric === 'Count') {
                        return;
                    }
                    
                    const key = `${row.Sbjct}_${row.Crse}_${row['Crse Title']}_${row.Metric}`;
                    if (!comparisonData.has(key)) {
                        comparisonData.set(key, {
                            'Subject': row.Sbjct,
                            'Course': row.Crse,
                            'Course_Title': row['Crse Title'],
                            'Metric': row.Metric,
                            'This_Instructor': '',
                            'All_Instructors': ''
                        });
                    }
                    
                    let value = row.Value;
                    // Handle arrays (like Terms)
                    if (Array.isArray(value)) {
                        value = value.join('; ');
                    }
                    comparisonData.get(key)['This_Instructor'] = value;
                });
            }
            
            // Process all instructors data
            if (allInstructorsDataForDownload && allInstructorsDataForDownload.length > 0) {
                allInstructorsDataForDownload.forEach(row => {
                    // Skip Count metric (same as UI filtering)
                    if (row.Metric === 'Count') {
                        return;
                    }
                    
                    const key = `${row.Sbjct}_${row.Crse}_${row['Crse Title']}_${row.Metric}`;
                    if (!comparisonData.has(key)) {
                        comparisonData.set(key, {
                            'Subject': row.Sbjct,
                            'Course': row.Crse,
                            'Course_Title': row['Crse Title'],
                            'Metric': row.Metric,
                            'This_Instructor': '',
                            'All_Instructors': ''
                        });
                    }
                    
                    let value = row.Value;
                    // Handle arrays (like Terms)
                    if (Array.isArray(value)) {
                        value = value.join('; ');
                    }
                    comparisonData.get(key)['All_Instructors'] = value;
                });
            }
            
            // Convert to array
            const comparisonArray = Array.from(comparisonData.values());
            
            if (comparisonArray.length === 0) {
                alert('No comparison data to download');
                return;
            }
            
            // Create CSV headers
            const headers = ['Subject', 'Course', 'Course_Title', 'Metric', 'This_Instructor', 'All_Instructors'];
            
            // Create CSV content
            const csvContent = [
                headers.join(','),
                ...comparisonArray.map(row => 
                    headers.map(header => {
                        let value = row[header] || '';
                        // Escape values containing commas
                        if (typeof value === 'string' && value.includes(',')) {
                            value = '"' + value + '"';
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');
            
            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Generate filename with current date and filters
            const instructor = document.getElementById('instructor').value.trim();
            const startYear = document.getElementById('startYear').value;
            const endYear = document.getElementById('endYear').value;
            
            let filename = 'fcq_data';
            if (allInstructorsDataForDownload.length > 0) {
                filename += '_all_instructors';
            } else if (instructor) {
                filename += `_${instructor.replace(/[^a-zA-Z0-9]/g, '_')}`;
            }
            if (startYear) filename += `_${startYear}`;
            if (endYear) filename += `_to_${endYear}`;
            filename += `_${new Date().toISOString().split('T')[0]}.csv`;
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // Global mode variable
        let currentMode = null;

        // Function to set mode and update UI
        function setMode(mode) {
            currentMode = mode;

            // Update button styles
            document.querySelectorAll('.banner button').forEach(btn => {
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-outline-secondary');
            });

            // Map mode to button ID
            const modeToButtonId = {
                'PUEC': 'puecBtn',
                'FRPA': 'frpaBtn',
                'Tenure': 'tenureBtn',
                'Full': 'fullBtn',
                'Ad hoc': 'adhocBtn'
            };

            const activeBtn = document.getElementById(modeToButtonId[mode]);
            activeBtn.classList.remove('btn-outline-secondary');
            activeBtn.classList.add('btn-secondary');

            const startYearSelect = document.getElementById('startYear');
            const endYearSelect = document.getElementById('endYear');
            const endYearDisplay = document.getElementById('endYearDisplay');
            const modeNote = document.getElementById('modeNote');
            const summerTermRow = document.getElementById('summerTermRow');
            const includeSummer = document.getElementById('includeSummer');

            // Remove all existing event listeners
            startYearSelect.removeEventListener('change', updateEndYearForPUEC);
            startYearSelect.removeEventListener('change', updateEndYearForFRPA);
            startYearSelect.removeEventListener('change', updateEndYearForTenure);
            startYearSelect.removeEventListener('change', updateEndYearForFull);
            startYearSelect.removeEventListener('change', validateAdHocDates);
            endYearSelect.removeEventListener('change', validateAdHocDates);
            includeSummer.removeEventListener('change', updateAdHocNote);

            // Reset dropdowns and repopulate based on mode
            repopulateDropdowns(mode);

            if (mode === 'PUEC') {
                startYearSelect.disabled = false;
                endYearSelect.style.display = 'none';
                endYearDisplay.style.display = 'block';
                summerTermRow.style.display = 'none';
                startYearSelect.addEventListener('change', updateEndYearForPUEC);
                modeNote.textContent = NOTE_TEXT_DEFAULT;
                if (startYearSelect.value) {
                    updateEndYearForPUEC();
                }
            } else if (mode === 'FRPA') {
                startYearSelect.disabled = false;
                endYearSelect.style.display = 'none';
                endYearDisplay.style.display = 'block';
                summerTermRow.style.display = 'none';
                startYearSelect.addEventListener('change', updateEndYearForFRPA);
                modeNote.textContent = NOTE_TEXT_FRPA;
                if (startYearSelect.value) {
                    updateEndYearForFRPA();
                }
            } else if (mode === 'Tenure') {
                startYearSelect.disabled = false;
                endYearSelect.style.display = 'none';
                endYearDisplay.style.display = 'block';
                summerTermRow.style.display = 'none';
                startYearSelect.addEventListener('change', updateEndYearForTenure);
                modeNote.textContent = NOTE_TEXT_DEFAULT;
                if (startYearSelect.value) {
                    updateEndYearForTenure();
                }
            } else if (mode === 'Full') {
                startYearSelect.disabled = false;
                endYearSelect.style.display = 'none';
                endYearDisplay.style.display = 'block';
                summerTermRow.style.display = 'none';
                startYearSelect.addEventListener('change', updateEndYearForFull);
                modeNote.textContent = NOTE_TEXT_DEFAULT;
                if (startYearSelect.value) {
                    updateEndYearForFull();
                }
            } else if (mode === 'Ad hoc') {
                startYearSelect.disabled = false;
                endYearSelect.style.display = 'block';
                endYearDisplay.style.display = 'none';
                summerTermRow.style.display = 'block';
                endYearSelect.disabled = false;

                // Add validation listeners for Ad hoc mode
                startYearSelect.addEventListener('change', validateAdHocDates);
                endYearSelect.addEventListener('change', validateAdHocDates);
                includeSummer.addEventListener('change', updateAdHocNote);

                // Set initial note text
                updateAdHocNote();
            }
        }

        // Function to repopulate dropdowns based on mode
        function repopulateDropdowns(mode) {
            const currentYear = new Date().getFullYear();
            const startYearSelect = document.getElementById('startYear');
            const endYearSelect = document.getElementById('endYear');
            const endYearDisplay = document.getElementById('endYearDisplay');

            // Clear existing options
            startYearSelect.innerHTML = '<option value="">Select start term...</option>';

            // Set end year content based on mode
            if (mode === 'Ad hoc') {
                endYearSelect.innerHTML = '<option value="">Select end term...</option>';
            } else {
                endYearDisplay.textContent = 'Select start term';
            }

            if (mode === 'FRPA') {
                // FRPA: Start term should be Spring
                for (let year = 2016; year <= currentYear + 1; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = `Spring ${year}`;
                    startYearSelect.appendChild(option);
                }
                // End year dropdown will be populated by the update function
            } else if (mode === 'Tenure' || mode === 'Full') {
                // Tenure/Full: Start term should be Fall
                for (let year = 2015; year <= currentYear; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = `Fall ${year}`;
                    startYearSelect.appendChild(option);
                }
            } else {
                // PUEC and Ad hoc: Fall terms for start
                for (let year = 2015; year <= currentYear; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = `Fall ${year}`;
                    startYearSelect.appendChild(option);
                }
            }

            // For Ad hoc mode, also populate end year dropdown
            if (mode === 'Ad hoc') {
                for (let year = 2002; year <= currentYear + 1; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = `Spring ${year}`;
                    endYearSelect.appendChild(option);
                }
            }
        }

        // Function to update end year for PUEC mode
        function updateEndYearForPUEC() {
            const startYearSelect = document.getElementById('startYear');
            const endYearSelect = document.getElementById('endYear');
            const endYearDisplay = document.getElementById('endYearDisplay');

            if (startYearSelect.value && currentMode === 'PUEC') {
                const startYear = parseInt(startYearSelect.value);
                const endYear = startYear + 3;
                endYearDisplay.textContent = `Spring ${endYear}`;
                endYearSelect.innerHTML = `<option value="${endYear}" selected>Spring ${endYear}</option>`;
            } else {
                endYearDisplay.textContent = 'Select start term';
            }
        }

        // Function to update end year for FRPA mode
        function updateEndYearForFRPA() {
            const startYearSelect = document.getElementById('startYear');
            const endYearSelect = document.getElementById('endYear');
            const endYearDisplay = document.getElementById('endYearDisplay');

            if (startYearSelect.value && currentMode === 'FRPA') {
                const startYear = parseInt(startYearSelect.value);
                const endYear = startYear; // Same year, Fall term
                endYearDisplay.textContent = `Fall ${endYear}`;
                endYearSelect.innerHTML = `<option value="${endYear}" selected>Fall ${endYear}</option>`;
            } else {
                endYearDisplay.textContent = 'Select start term';
            }
        }

        // Function to update end year for Tenure mode
        function updateEndYearForTenure() {
            const startYearSelect = document.getElementById('startYear');
            const endYearSelect = document.getElementById('endYear');
            const endYearDisplay = document.getElementById('endYearDisplay');

            if (startYearSelect.value && currentMode === 'Tenure') {
                const startYear = parseInt(startYearSelect.value);
                const endYear = startYear + 5;
                endYearDisplay.textContent = `Spring ${endYear}`;
                endYearSelect.innerHTML = `<option value="${endYear}" selected>Spring ${endYear}</option>`;
            } else {
                endYearDisplay.textContent = 'Select start term';
            }
        }

        // Function to update end year for Full mode
        function updateEndYearForFull() {
            const startYearSelect = document.getElementById('startYear');
            const endYearSelect = document.getElementById('endYear');
            const endYearDisplay = document.getElementById('endYearDisplay');

            if (startYearSelect.value && currentMode === 'Full') {
                const startYear = parseInt(startYearSelect.value);
                const endYear = startYear + 10;
                endYearDisplay.textContent = `Spring ${endYear}`;
                endYearSelect.innerHTML = `<option value="${endYear}" selected>Spring ${endYear}</option>`;
            } else {
                endYearDisplay.textContent = 'Select start term';
            }
        }

        // Function to update Ad hoc mode note based on summer term checkbox
        function updateAdHocNote() {
            const includeSummer = document.getElementById('includeSummer');
            const modeNote = document.getElementById('modeNote');

            if (currentMode === 'Ad hoc') {
                if (includeSummer.checked) {
                    modeNote.textContent = NOTE_TEXT_AD_HOC_WITH_SUMMER;
                } else {
                    modeNote.textContent = "Note: Start and end terms are included in results. Analysis based on BUSN classes only. Undergraduate classes (i.e., 4000-level and below) with enrollments below 10 are excluded from statistics.";
                }
                modeNote.style.color = '';
            }
        }

        // Function to validate Ad hoc mode dates and filter end year options
        function validateAdHocDates() {
            const startYearSelect = document.getElementById('startYear');
            const endYearSelect = document.getElementById('endYear');
            const modeNote = document.getElementById('modeNote');

            if (currentMode === 'Ad hoc') {
                // Filter end year options based on start year selection
                if (startYearSelect.value) {
                    const startYear = parseInt(startYearSelect.value);
                    const currentYear = new Date().getFullYear();
                    const selectedEndYear = endYearSelect.value;

                    // Clear and repopulate end year dropdown with valid options only
                    endYearSelect.innerHTML = '<option value="">Select end term...</option>';

                    // For Fall start terms, the earliest valid Spring end term is the following year
                    // Fall 2017 -> earliest Spring end is Spring 2018
                    const earliestEndYear = startYear + 1;

                    // Add options from earliest valid end year onwards
                    for (let year = earliestEndYear; year <= currentYear + 1; year++) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = `Spring ${year}`;

                        // Restore selection if it's still valid
                        if (year.toString() === selectedEndYear && year >= earliestEndYear) {
                            option.selected = true;
                        }

                        endYearSelect.appendChild(option);
                    }
                }

                // Validate current selection
                if (startYearSelect.value && endYearSelect.value) {
                    const startYear = parseInt(startYearSelect.value);
                    const endYear = parseInt(endYearSelect.value);
                    const earliestEndYear = startYear + 1;

                    if (endYear < earliestEndYear) {
                        modeNote.innerHTML = '<span style="color: #dc3545;">Error: End term must be after start term (Fall to Spring sequence).</span>';
                        modeNote.style.color = '#dc3545';
                    } else {
                        updateAdHocNote(); // Use the note update function to set proper text
                    }
                } else {
                    updateAdHocNote(); // Use the note update function to set proper text
                }
            }
        }

        // Initialize page on load
        document.addEventListener('DOMContentLoaded', () => {
            // Set default mode to PUEC
            setMode('PUEC');

            // Set default start year for PUEC mode
            const currentYear = new Date().getFullYear();
            const startYearSelect = document.getElementById('startYear');
            startYearSelect.value = currentYear - 3;
            updateEndYearForPUEC();

            // Initialize tooltips
            initTooltips();
        });
    </script>

    <footer style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #e5e7eb; color: #6c757d; font-size: 0.9em;">
        <div>Version 1.2.0</div>
        <div style="margin-top: 5px;">Please send suggestions or bug reports to abram.handler@gmail.com</div>
    </footer>
</body>
</html>